<!DOCTYPE html>
<html>
	<head>
		<title>Momotutus</title>

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<style type="text/css">
			td {
				margin : 0;
				padding: 0;
				border : black solid 1px;
				
			}

			table, tr, td {
				border-collapse: collapse;
				background-image: linear-gradient(#2070ff, #0040ff);
			}

			body {
				background-color: #C6E2FF;
			}

			.wrong-place {
				background-color: #ffc300;
				width: 40px;
				height: 40px;
				border-radius: 40px;
				margin-left: 5px;
				text-align: center;
				text-transform: uppercase;
				font-weight: bold;
				color: white;
				font-size: 24px;
			}

			.normal {
				border : 0px;
				width: 50px;
				height: 50px;
				text-align: center;
				font-size: 24px;
				background-image: linear-gradient(#2070ff, #0040ff);
			}

			.wrong {
				border : 0px;
				width: 50px;
				height: 50px;
				text-align: center;
				font-size: 24px;
				background-color: darkblue;
				text-transform: uppercase;
				font-weight: bold;
				color: white;
			}

			.right {
				border : 0px;
				width: 50px;
				height: 50px;
				text-align: center;
				font-size: 24px;
				background-color: red;
				text-transform: uppercase;
				font-weight: bold;
				color: white;				
			}

			.case {
				border : 0px;
				width: 50px;
				height: 50px;
				text-align: center;
				font-size: 24px;
				background-image: linear-gradient(#2070ff, #0040ff);
				text-transform: uppercase;
				font-weight: bold;
				color: white;
			}

			h1 {
				text-align: center;
				margin: 5% 0; 
			}

			button {
				margin: 3% 0;
			}

			.case::placeholder {
			  color: white;
			}

			.sctime {
				font-size: 40px;
				color: red;
				font-family: "Times New Roman", Times, serif;
				background-color: yellow;
				width: 50px;
				height: 50px;
				border-radius: 50px;
				text-align: center;
				vertical-align: middle;
				font-weight: bolder;
				line-height: 50px;
				padding: auto;
			}

		</style>
		
	</head>
	<body>
		<div class="container">
			<h1> MOTUS </h1>

			<div class="row justify-content-md-center">
				<div id="mainmenu" class="col-md-auto col-lg-4 menu">
					<div class="row">
						<button type="button" class="col-lg-12 btn btn-primary btn-lg" id="ngame">New game</button>
					</div>

					<div class="row">
						<button type="button" class="col-lg-12 btn btn-primary btn-lg" id="option">Option</button>
					</div>

					<div class="row">
						<button type="button" class="col-lg-12 btn btn-primary btn-lg" id="a_propos">A propos</button>
					</div>

					<div class="row">
						<p>Version 0.54</p>
					</div>
				</div>

				<div id="game" class="menu">
					<table id="grille">
					</table>
					<div id="scoreDiv"> Score : <div class="sctime" id="score"></div></div>
					<div id="timeDiv"> Temps : <div class="sctime" id="time"></div></div>
					<!--<div class="row">
						<button type="button" class="col-lg-6 btn btn-primary btn-lg" id="nxtWord">Mot suivant</button>
						<button type="button" class="col-lg-6 btn btn-primary btn-lg" id="reportWord">Signaler le mot</button>
					</div>-->
					<div class="row">
						<button type="button" class="col-lg-12 btn btn-primary btn-lg" id="backMainGame">Retour au menu</button>
					</div>
				</div>

				<div id="optionMenu" class="col-md-auto col-lg-4 menu">
					<div class="row"><label class="col-md-auto col-lg-6">Nombre de lettre :</label><input name="1" class="col-md-auto col-lg-6" value="7" disabled ="true" type="number" id="nbLetterInput"></div>
					<div class="row"><label class="col-md-auto col-lg-6">Nombre de ligne :</label><input name="2" class="col-md-auto col-lg-6" value="6" type="number" id="nbLigneInput"></div>
					<div class="row"><label class="col-md-auto col-lg-6">Temps :</label><input name="3" class="col-md-auto col-lg-6" type="number" value="30" id="timeInput"></div>
					<div class="row"><label class="col-md-auto col-lg-6">Position du curseur au début :</label><input name="4" class="col-md-auto col-lg-6" 	checked="true" type="checkbox" id="positionCurseur"></div>
					<div class="row">
						<button type="button" class="col-lg-12 btn btn-primary btn-lg" id="valOption">Valider</button>
					</div>
					<div class="row">
						<button type="button" class="col-lg-12 btn btn-primary btn-lg backMainOption">Retour au menu</button>
					</div>
				</div>

				<div id="patchNote" class="col-md-auto col-lg-4 menu">
					<h3> Regle </h3>
					<br>
					<p>#TO DO</p>
					<br>
					<h3>Patch note</h3>
					<br>
					<ul>
						<li>In progress</li>
						<p>Signalement des mots incoherents</p>
						<hr>
						<li>Patch 0.54 - 30/11/2018</li>
						<p>Fix bug on phone</p>
						<p>Ajout du patch note</p>
						<hr>
						<li>Patch 0.53 - 28/11/2018</li>
						<p>Deplacement entre case avec les fleches</p>
					</ul>

					<div class="row">
						<button type="button" class="col-lg-12 btn btn-primary btn-lg backMainOption">Retour au menu</button>
					</div>

				</div>

			</div>
		</div>



	<script type="text/javascript" src="Mots.js"></script>
	<script type="text/javascript">

		var nbRow = 6;
		var Row = 0;
		var nbLetter = 7;
		var activeRow = 0;
		var trueResponse = "";
		var listeLettre = [];
		var lettrePlacee = [];
		var trueResponse;
		var time = 0;
		var timeByReponse = 30;
		var fini = true;
		var chronoInterval;
		var position = true;
		var score = 0;

		function chrono() {
			if (!fini && time != 0) {
				time--;
				$("#time").text(time);
				if (time == 0) { nextRow(); fini = true;}
			} else {
				time = timeByReponse;
			}
		}

		function menuSelect(menuSelect) {
			$(".menu").hide();
			menuSelect.show();
		}

		window.onload = (function(){
			$("#score").text(score);
			menuSelect($("#mainmenu"));
			var grille = document.getElementById("grille");

			
			$("#backMainGame").click(function(){
				window.clearInterval(chronoInterval);
				$("#grille").empty();
				score = 0;
				menuSelect($("#mainmenu"));
			});

			$(".backMainOption").click(function(){
				menuSelect($("#mainmenu"));
			});

			$("#a_propos").click(function(){
				menuSelect($("#patchNote"));
			});

			$("#option").click(function(){
				menuSelect($("#optionMenu"));
			})

			$("#valOption").click(function(){
				nbRow = $("#nbLigneInput").val();
				//nbLetter = $("nbLetterInput");
				position = $("#positionCurseur").is(':checked');
				timeByReponse = $("#timeInput").val();
				menuSelect($("#mainmenu"));
			});

			

			document.getElementById("ngame").onclick = function() {
				$("#mainmenu").hide();
				$("#game").show();
				$("#time").text(timeByReponse);
				for (var i = 0; i < nbRow; i++) {
					console.log("row");
					grille.innerHTML += "<tr id=row"+i+"></tr>";
					var currentRow = document.getElementById("row"+i);
					if ( i == 0) {
						for (var j = 0;  j < nbLetter; j++) {
							currentRow.innerHTML += "<td id=row"+i+"input"+j+"><input class='case' placeholder='_' onkeydown='nextCase(this, event)'/></td>";
						}
					} else {
						for (var j = 0;  j < nbLetter; j++) {
							currentRow.innerHTML += "<td id=row"+i+"input"+j+"><input class='case' disabled onkeydown='nextCase(this, event)'/></td>";
						}	
					}
				}

				setNewGrid();
				placeLettre();

				chronoInterval = window.setInterval('chrono()', 1000);

			}


		});

		function nextCase(el, ev) {
			//ev.preventDefault();
			var keynum = ev.keyCode;

			switch (keynum) {

				case 37 :
					console.log("left");
					if (el.parentElement.previousSibling != null) {
						var prevEl = el.parentElement.previousSibling.children[0];
						console.log("element:", el,"previous",prevEl);
						prevEl.focus();
					}
				break;

				case 39 :
					console.log("right");
					if (el.parentElement.nextSibling != null) {
						var nextEl = el.parentElement.nextSibling.children[0];
						nextEl.focus();
					}
				break;
				
				// case retour arriere :

				case 13 /* enter */ :

				if (!fini) {
					fini = true;
					validate = true;
					validResponse();
				}
					break;

				default :
					console.log(keynum);
					el.value = null;
					if (el.parentElement.nextSibling != null) {
						var nextEl = el.parentElement.nextSibling.children[0];
						nextEl.focus();
					}
				break;
			}
		}

		function validResponse() {
			listeLettre = [];
			//On stocke dans un tableau les lettres du mot
			
			for (i = 0; i<trueResponse.length; i++) {
				listeLettre.push(trueResponse[i]);
			}

			var elActiv = document.getElementById("row"+activeRow);
			var response = "";
			

			// On crée une response en concatenant les lettres dans les cases
			for(i = 0; i < elActiv.children["length"]; i++) {
				response += elActiv.children[i].children[0].value;
			}
			////////
			console.log(response, test.indexOf(response));
			if (test.indexOf(response) != -1) {

				for (i = 0; i < trueResponse.length; i++) {
					checkResponse(response, trueResponse, i);
				}

				//listeLettre = [];

				if (trueResponse == response ) {
					nextQuestion();
					score++;
					$("#score").val(text);
				} else {
					nextRow();
				}	
			} else {
				nextRow();
			}	
		}

		function afficheReponse() {
			for (i = 0; i < nbLetter; i++) {
				document.getElementById("row"+activeRow+"input"+i).children[0].value = trueResponse[i];
			}
		}

		function checkResponse(response, trueResponse, i) {
			setTimeout(function() {
				//console.log(i);
				var el = document.getElementById("row"+activeRow+"input"+i).children[0];
				el.disabled = true;
				if (response[i] == trueResponse[i]) {
					listeLettre[i] = null;
					el.className = "right";
					lettrePlacee[i] = true;
				} else {
					for (j = 0; j < listeLettre.length; j ++) {
						if (listeLettre[j] == response[i] &&
							response[j] != trueResponse[j])
						{
							listeLettre[j] = null;
							el.className = "wrong-place";
							//console.log(listeLettre, trueResponse, response);
							return;
						}
						console.log(listeLettre, trueResponse, response);	
					}
					el.className = "wrong";
				}
			}, i*500);
		}

		function nextQuestion() {
			setTimeout(function() {
				$("#game input").addClass("case");
				$("#game input").val()=null;
				setNewGrid();
			}, (nbLetter+3)*500);
		}

		function nextRow() {
			if (activeRow+1 >= nbRow) {
				setTimeout(function() {
					nextQuestion();
					return;
				}, 3000)
				afficheReponse();

			} else {
				setTimeout(function() {
					fini = false;
					time = timeByReponse;
					activeRow++;
					var coll = document.getElementById("row"+activeRow).children;
					for (i = 0; i < coll.length; i++) {
						coll[i].children[0].disabled = false;
						coll[i].children[0].setAttribute("placeholder", "_");
					}
					placeLettre();
					console.log(activeRow*nbLetter-1);
					if (position) {
						for (i = 0; i < nbLetter; i++) {
							if (!lettrePlacee[i]) {
								document.getElementsByTagName("input")[activeRow*nbLetter+i].focus();
								i = nbLetter;
							}
						}
					} else {
						document.getElementsByTagName("input")[activeRow*nbLetter].focus();
					}
					
				}, nbLetter*500);
			}
		}

		function placeLettre() {
			for (i = 0; i < nbLetter; i++) {
				if (lettrePlacee[i]) {
					document.getElementById("row"+activeRow+"input"+i).children[0].value = trueResponse[i];
				}
			}
		}

		function setNewGrid() {
			$("#game input").addClass("case");
			trueResponse = test[Math.round(Math.random()*test.length)];
			activeRow = 0;
			lettrePlacee = [];
			for (i = 0; i < nbLetter; i++) {
				lettrePlacee.push(false);
				document.getElementsByTagName("input")[i].disabled = false;
			}
			document.getElementsByTagName("input")[0].focus();

			// 2 lettres déjà placée
			var rand = Math.round(Math.random()*(nbLetter-1))+1;
			lettrePlacee[0] = true;
			lettrePlacee[rand] = true;
			fini = false;
			time = timeByReponse;
			// document.getElementById("row0input"+rand1).children[0].value = trueResponse[rand1];
			// document.getElementById("row0input"+rand2).children[0].value = trueResponse[rand2];

			placeLettre();
		}

		
	</script>
	</body>
</html>